{"version":3,"sources":["Auth/Authenticator.ts"],"names":[],"mappings":";;AACA,oCAA8C;AAC9C,gCAOiB;AACjB,yCAAkD;AAClD,oCAAyC;AACzC,0DAAyD;AACzD,4CAA8C;AAC9C,kCAAyC;AACzC,2CAA0C;AAE1C,+BAA8B;AAE9B;IASC,uBAAa,OAAe;QAC3B,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;IACxB,CAAC;IAND,sBAAI,4CAAiB;aAArB,cAA+B,OAAO,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC;;;OAAA;IAQhE,uCAAe,GAAf;QACC,OAAO,CAAE,CAAE,IAAI,CAAC,YAAY,CAAC;IAC9B,CAAC;IAID,2CAAmB,GAAnB;QACC,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;IAChC,CAAC;IAED,yCAAiB,GAAjB,UAAmB,cAA6B;QAC/C,IAAI,cAAc,CAAC,OAAO,IAAI,cAAc,CAAC,OAAO,CAAC,GAAG,CAAE,eAAe,CAAE;YAAG,OAAO,cAAc,CAAC;QAEpG,IAAI,CAAE,IAAI,CAAC,eAAe,EAAE;YAAG,MAAM,IAAI,0BAAiB,CAAE,wCAAwC,CAAE,CAAC;QACvG,IAAI,CAAE,cAAc,CAAC,OAAO;YAAG,cAAc,CAAC,OAAO,GAAG,IAAI,GAAG,EAAkB,CAAC;QAElF,IAAM,aAAa,GAAU,IAAI,CAAC,eAAe,EAAE,CAAC;QACpD,cAAc,CAAC,OAAO,CAAC,GAAG,CAAE,eAAe,EAAE,IAAI,aAAM,CAAE,CAAE,aAAa,CAAE,CAAE,CAAE,CAAC;QAE/E,OAAO,cAAc,CAAC;IACvB,CAAC;IAED,4CAAoB,GAApB,UAAsB,cAA8B;QAApD,iBAgCC;QAhCqB,+BAAA,EAAA,mBAA8B;QACnD,IAAI,IAAI,CAAC,kBAAkB;YAAG,OAAO,OAAO,CAAC,OAAO,CAAE,IAAI,CAAC,kBAAkB,CAAE,CAAC;QAEhF,OAAO,qBAAa,CAAE;YACrB,IAAM,WAAW,GAAU,KAAI,CAAC,OAAO,CAAC,YAAY,CAAE,UAAU,CAAE,CAAC;YAEnE,IAAM,YAAY,GAAc,mBAAY,CAAC,YAAY,CAAE,cAAc,CAAE,CAAC;YAC5E,KAAI,CAAC,iBAAiB,CAAE,YAAY,CAAE,CAAC;YACvC,mBAAY,CAAC,eAAe,CAAE,qBAAqB,EAAE,YAAY,CAAE,CAAC;YACpE,mBAAY,CAAC,4BAA4B,CAAE,SAAG,CAAC,SAAS,EAAE,YAAY,CAAE,CAAC;YACzE,YAAY,CAAC,YAAY,GAAG,IAAI,CAAC;YAEjC,OAAO,qBAAc;iBACnB,GAAG,CAAE,WAAW,EAAE,YAAY,EAAE,IAAI,qBAAY,EAAE,CAAE;iBACpD,KAAK,CAAE,UAAA,QAAQ,IAAI,OAAA,KAAI,CAAC,OAAO,CAAC,SAAS,CAAC,mBAAmB,CAAE,QAAQ,CAAE,EAAtD,CAAsD,CAAE,CAC3E;QACH,CAAC,CAAE,CAAC,IAAI,CAAE,UAAE,EAAqB;gBAAnB,eAAO,EAAE,gBAAQ;YAC9B,IAAM,QAAQ,GAAwC,KAAI,CAAC,iBAAiB,CAAE,OAAO,EAAE,QAAQ,EAAE,cAAc,CAAE,CAAC;YAGlH,KAAI,CAAC,kBAAkB,GAAG,qCAAiB,CAAC,QAAQ,CACnD,QAAQ;iBACN,yBAAyB;iBACzB,IAAI,EACN,KAAI,CAAC,OAAO,CAAC,SAAS,CACtB,CAAC;YAEF,KAAI,CAAC,kBAAkB;iBACrB,OAAO,CAAE,WAAI,CAAC,IAAI,CAAE,CAAC;YAEvB,OAAO,KAAI,CAAC,kBAAkB,CAAC;QAChC,CAAC,CAAE,CAAC;IACL,CAAC;IAIS,yCAAiB,GAA3B,UAA6B,OAAgB,EAAE,QAAiB,EAAE,cAA0B;QAC3F,IAAM,WAAW,GAAU,IAAI,CAAC,OAAO,CAAC,YAAY,CAAE,UAAU,CAAE,CAAC;QAEnE,IAAM,YAAY,GAAiB,sBAAW;aAC5C,YAAY,CAAE,OAAO,CAAE;aACvB,MAAM,CAAE,UAAA,WAAW,IAAI,OAAA,WAAW,CAAE,KAAK,CAAE,KAAK,WAAW,EAApC,CAAoC,CAAE,CAAC;QAEhE,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;YAAG,MAAM,IAAI,yBAAgB,CAAE,0CAA0C,EAAE,QAAQ,CAAE,CAAC;QAEnH,OAAO,IAAI,CAAC,OAAO,CAAC,SAAS;aAC3B,mBAAmB,CAAE,YAAY,CAAE,CAAC,CAAE,EAAE,QAAQ,CAAE,CAAC;IACtD,CAAC;IAEF,oBAAC;AAAD,CArFA,AAqFC,IAAA;AArFqB,sCAAa","file":"Authenticator.js","sourcesContent":["import { Context } from \"../Context\";\nimport { IllegalStateError } from \"../Errors\";\nimport {\n\tGETOptions,\n\tHeader,\n\tRequestOptions,\n\tRequestService,\n\tRequestUtils,\n\tResponse,\n} from \"../HTTP\";\nimport { BadResponseError } from \"../HTTP/Errors\";\nimport { JSONLDParser } from \"../JSONLD\";\nimport { ProtectedDocument } from \"../ProtectedDocument\";\nimport { RDFDocument } from \"../RDF/Document\";\nimport { promiseMethod } from \"../Utils\";\nimport { LDP } from \"../Vocabularies/LDP\";\nimport { AuthenticatedUserInformationAccessor } from \"./AuthenticatedUserInformationAccessor\";\nimport { User } from \"./User\";\n\nexport abstract class Authenticator<T extends object, W extends object> {\n\n\tprotected context:Context;\n\n\tprotected _authenticatedUser?:User;\n\tget authenticatedUser():User { return this._authenticatedUser; }\n\n\tprotected abstract _credentials?:W;\n\n\tconstructor( context:Context ) {\n\t\tthis.context = context;\n\t}\n\n\tisAuthenticated():boolean {\n\t\treturn ! ! this._credentials;\n\t}\n\n\tabstract authenticate( authenticationToken:T ):Promise<W>;\n\n\tclearAuthentication():void {\n\t\tthis._credentials = null;\n\t\tthis._authenticatedUser = null;\n\t}\n\n\taddAuthentication( requestOptions:RequestOptions ):RequestOptions {\n\t\tif( requestOptions.headers && requestOptions.headers.has( \"authorization\" ) ) return requestOptions;\n\n\t\tif( ! this.isAuthenticated() ) throw new IllegalStateError( \"The authenticator isn't authenticated.\" );\n\t\tif( ! requestOptions.headers ) requestOptions.headers = new Map<string, Header>();\n\n\t\tconst strAuthHeader:string = this._getHeaderValue();\n\t\trequestOptions.headers.set( \"authorization\", new Header( [ strAuthHeader ] ) );\n\n\t\treturn requestOptions;\n\t}\n\n\tgetAuthenticatedUser( requestOptions:GETOptions = {} ):Promise<User> {\n\t\tif( this._authenticatedUser ) return Promise.resolve( this._authenticatedUser );\n\n\t\treturn promiseMethod( () => {\n\t\t\tconst metadataURI:string = this.context._resolvePath( \"users.me\" );\n\n\t\t\tconst localOptions:GETOptions = RequestUtils.cloneOptions( requestOptions );\n\t\t\tthis.addAuthentication( localOptions );\n\t\t\tRequestUtils.setAcceptHeader( \"application/ld+json\", localOptions );\n\t\t\tRequestUtils.setPreferredInteractionModel( LDP.RDFSource, localOptions );\n\t\t\tlocalOptions.ensureLatest = true;\n\n\t\t\treturn RequestService\n\t\t\t\t.get( metadataURI, localOptions, new JSONLDParser() )\n\t\t\t\t.catch( response => this.context.documents._parseErrorResponse( response ) )\n\t\t\t\t;\n\t\t} ).then( ( [ rdfData, response ] ) => {\n\t\t\tconst accessor:AuthenticatedUserInformationAccessor = this._parseRDFMetadata( rdfData, response, requestOptions );\n\n\t\t\t// TODO: Remove decoration when #260 merged\n\t\t\tthis._authenticatedUser = ProtectedDocument.decorate(\n\t\t\t\taccessor\n\t\t\t\t\t.authenticatedUserMetadata\n\t\t\t\t\t.user,\n\t\t\t\tthis.context.documents\n\t\t\t);\n\n\t\t\tthis._authenticatedUser\n\t\t\t\t.addType( User.TYPE );\n\n\t\t\treturn this._authenticatedUser;\n\t\t} );\n\t}\n\n\tprotected abstract _getHeaderValue():string;\n\n\tprotected _parseRDFMetadata( rdfData:object[], response:Response, requestOptions?:GETOptions ):AuthenticatedUserInformationAccessor {\n\t\tconst metadataURI:string = this.context._resolvePath( \"users.me\" );\n\n\t\tconst metadataRDFs:RDFDocument[] = RDFDocument\n\t\t\t.getDocuments( rdfData )\n\t\t\t.filter( rdfDocument => rdfDocument[ \"@id\" ] === metadataURI );\n\n\t\tif( metadataRDFs.length !== 1 ) throw new BadResponseError( \"No correct cs:UserMetadata was returned.\", response );\n\n\t\treturn this.context.documents\n\t\t\t._convertRDFDocument( metadataRDFs[ 0 ], response );\n\t}\n\n}\n"]}